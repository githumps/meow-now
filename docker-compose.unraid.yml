# Docker Compose for Unraid
# Optimized for Unraid deployment with proper networking and volume management

version: '3.8'

services:
  meow-now:
    image: ghcr.io/githumps/meow-now:latest
    container_name: meow-now
    restart: unless-stopped
    ports:
      - "5000:5000"   # Web UI
      - "4573:4573"   # AGI server (internal to Asterisk)
    volumes:
      # Use Unraid appdata paths
      - /mnt/user/appdata/meow-now/audio:/app/audio
      - /mnt/user/appdata/meow-now/logs:/app/logs
      - /mnt/user/appdata/meow-now/models:/app/models
      - /mnt/user/appdata/meow-now/.env:/app/.env:ro
    environment:
      - FLASK_ENV=production
      - LOG_LEVEL=INFO
      - OLLAMA_URL=${OLLAMA_URL:-}
      - TTS_ENGINE=${TTS_ENGINE:-piper}
      - ENABLE_GRUMPY_CAT=${ENABLE_GRUMPY_CAT:-True}
      - ENABLE_WISE_CAT=${ENABLE_WISE_CAT:-True}
      - ENABLE_ANXIOUS_CAT=${ENABLE_ANXIOUS_CAT:-True}
      - ENABLE_DIVA_CAT=${ENABLE_DIVA_CAT:-True}
    networks:
      - meow-network
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:5000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "net.unraid.docker.managed=composeman"
      - "net.unraid.docker.webui=http://[IP]:5000"
      - "net.unraid.docker.icon=https://raw.githubusercontent.com/githumps/meow-now/main/docs/icon.png"

  asterisk:
    image: andrius/asterisk:latest
    container_name: meow-asterisk
    restart: unless-stopped
    ports:
      - "5060:5060/udp"   # SIP
      - "5061:5061/tcp"   # SIP TLS
      - "10000-10099:10000-10099/udp"  # RTP
    volumes:
      # Mount your Asterisk config from appdata
      - /mnt/user/appdata/meow-now/asterisk/config:/etc/asterisk
      - /mnt/user/appdata/meow-now/asterisk/data:/var/lib/asterisk
      - /mnt/user/appdata/meow-now/asterisk/logs:/var/log/asterisk
    networks:
      - meow-network
    depends_on:
      - meow-now
    labels:
      - "net.unraid.docker.managed=composeman"

networks:
  meow-network:
    driver: bridge

# Note: Before first run, copy your Asterisk config files to:
# /mnt/user/appdata/meow-now/asterisk/config/
#
# See DEPLOYMENT.md for complete setup instructions.
