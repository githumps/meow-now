version: '3.8'

services:
  meow-now:
    build: .
    container_name: meow-now
    restart: unless-stopped
    ports:
      - "5000:5000"   # Flask web interface
      - "4573:4573"   # AGI server
    volumes:
      # Persistent storage for audio files
      - ./audio:/app/audio
      - ./logs:/app/logs
      - ./models:/app/models
      # Mount .env file for configuration
      - ./.env:/app/.env:ro
    environment:
      # Can override .env variables here
      - FLASK_ENV=production
      - LOG_LEVEL=INFO
      # Ollama URL (via Tailscale)
      - OLLAMA_URL=${OLLAMA_URL:-}
    networks:
      - meow-network
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:5000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Optional: Include Asterisk container if you want all-in-one deployment
  asterisk:
    image: andrius/asterisk:latest
    container_name: meow-asterisk
    restart: unless-stopped
    ports:
      - "5060:5060/udp"   # SIP
      - "5061:5061/tcp"   # SIP TLS
      - "10000-10099:10000-10099/udp"  # RTP
    volumes:
      - ./config/asterisk:/etc/asterisk
      - ./asterisk-data:/var/lib/asterisk
      - ./asterisk-logs:/var/log/asterisk
    networks:
      - meow-network
    depends_on:
      - meow-now

networks:
  meow-network:
    driver: bridge

volumes:
  asterisk-data:
  asterisk-logs:
